<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Games â€¢ GamerBridge</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#000; color:#e5e7eb; }
    .card.bg-dark { background:#1b1b1b; }
    .subscribed { background:#6b7280 !important; color:#fff !important; border-color:transparent !important; }
    .card.bg-dark { background-color: #1b1b1b !important; }
    .subscribed { border-color: transparent !important; }
  </style>

  <meta name="current-customer-id" content="">
  <meta name="_csrf" content="${_csrf.token}">
  <meta name="_csrf_header" content="${_csrf.headerName}">
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top border-bottom border-dark bg-dark">
  <div class="container">
    <a class="navbar-brand text-white" href="index.html">ðŸŽ® GamerBridge</a>

    <div class="d-flex gap-2 ms-auto">
      <a class="btn btn-sm btn-outline-light" href="userpro.html">Profile</a>
      <a class="btn btn-sm btn-success" href="addgame.html">Add Game</a>
    </div>
  </div>
</nav>

  <main class="container py-4">
    <div class="row mb-3">
      <div class="col-12">
        <form id="searchForm" class="d-flex gap-2" autocomplete="off">
          <input id="searchInput" class="form-control" type="search" name="q" placeholder="Search by title..." />
          <button id="clearBtn" class="btn btn-outline-secondary" type="button">Clear</button>
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
      </div>
    </div>

    <div id="grid" class="row g-3"></div>
  </main>

  <footer class="mt-5 py-4">
    <div class="container"><small class="text-muted">Â© 2025 GamerBridge</small></div>
  </footer>

  <script type="module">
    let currentCustomerId = null;

    async function loadCurrentUser() {
      try {
        const r = await fetch('/api/me', { credentials: 'same-origin' });
        if (!r.ok) return null;
        const data = await r.json().catch(()=>null);
        if (data && data.id) {
          currentCustomerId = String(data.id);
          window.currentCustomerId = currentCustomerId;
          const m = document.querySelector('meta[name="current-customer-id"]');
          if (m) m.setAttribute('content', currentCustomerId);
          return currentCustomerId;
        }
      } catch (e) {
        console.warn('Could not load current user', e);
      }
      return null;
    }

    function esc(s){ return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):''; }

    function isSubscribed(id){
      try { const s = JSON.parse(localStorage.getItem('subscriptions')||'{}'); return !!s[id]; } catch(e){ return false; }
    }
    function setLocalSub(id, val){
      try {
        const s = JSON.parse(localStorage.getItem('subscriptions')||'{}');
        if(val) s[id] = true; else delete s[id];
        localStorage.setItem('subscriptions', JSON.stringify(s));
      } catch(e){}
    }

    function card(g){
      const id = g.id ?? g.gameId ?? g._id ?? '';
      const img = esc(g.image || '/assets/img/placeholder.png');
      const title = esc(g.name || g.title || 'Untitled');
      const genre = esc(g.genre || 'â€”');
      const desc = esc(g.description || '').slice(0,140);
      const price = (g.price !== undefined && g.price !== null) ? ('$' + Number(g.price).toFixed(2)) : '';
      const view = id ? `<a class="btn btn-sm btn-primary" href="gamedetails.html?id=${encodeURIComponent(id)}">View</a>` : '';
      const edit = id ? `<a class="btn btn-sm btn-outline-info" href="editgame.html?id=${encodeURIComponent(id)}">Edit</a>` : '';
      const del = id ? `<button class="btn btn-sm btn-outline-danger" data-del="${encodeURIComponent(id)}">Delete</button>` : '';
      const subText = isSubscribed(id) ? 'Subscribed' : 'Subscribe';
      const subClass = isSubscribed(id) ? 'subscribed' : '';

      return `
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card h-100 bg-dark text-white">
            <img src="${img}" class="card-img-top" alt="${title}" style="height:180px;object-fit:cover;">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title mb-1">${title}</h5>
                <small class="text-muted">${genre}</small>
              </div>
              <p class="card-text text-secondary small mt-2">${desc}${(g.description && g.description.length>140)?'â€¦':''}</p>
              <div class="mt-auto d-flex gap-2 align-items-center">
                ${view}
                ${edit}
                ${del}
                <button class="btn btn-sm btn-outline-warning ${subClass}" data-sub="${encodeURIComponent(id)}">${subText}</button>
                <div class="ms-auto text-white">${price}</div>
              </div>
            </div>
          </div>
        </div>`;
    }

    let currentQuery = '';

    async function handleDelete(id) {
      if (!id) return;
      if (!confirm('Delete this game?')) return;
      try {
        const res = await fetch('/api/games/' + encodeURIComponent(id), { method: 'DELETE', credentials: 'same-origin' });
        if (!res.ok) {
          const text = await res.text().catch(()=> '');
          throw new Error(text || `HTTP ${res.status}`);
        }
        await load(currentQuery);
      } catch (err) {
        console.error('Delete error', err);
        alert('Delete failed: ' + (err.message || 'unknown error'));
      }
    }

    async function handleCardSubscribe(id, btn){
      if(!id) return;

      const customerId = currentCustomerId || document.querySelector('meta[name="current-customer-id"]')?.content || null;
      if(!customerId){
        alert('You must be logged in to subscribe.');
        return;
      }

      const currently = isSubscribed(id);
      btn.disabled = true;
      btn.textContent = currently ? 'Unsubscribingâ€¦' : 'Subscribingâ€¦';

      const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || null;
      let csrfHeaderRaw = document.querySelector('meta[name="_csrf_header"]')?.content || '';
      const safeHeaderName = (/^[A-Za-z0-9-]+$/).test(csrfHeaderRaw) ? csrfHeaderRaw : (csrfToken ? 'X-CSRF-TOKEN' : null);

      try {
        const url = `/api/customers/${encodeURIComponent(customerId)}/subscriptions`;
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken && safeHeaderName) headers[safeHeaderName] = csrfToken;

        const numericGameId = Number(id);
        const bodyJson = JSON.stringify({ planName: 'basic', gameId: numericGameId });

        const opts = !currently
          ? { method: 'POST', credentials: 'same-origin', headers, body: bodyJson }
          : { method: 'DELETE', credentials: 'same-origin', headers, body: JSON.stringify({ gameId: numericGameId }) };

        const r = await fetch(url, opts);
        const text = await r.text().catch(()=>null);
        let json;
        try { json = text ? JSON.parse(text) : null; } catch(e){ json = text; }

        if (!r.ok) {
          throw new Error((json && json.message) || (json && json.error) || text || `HTTP ${r.status}`);
        }

        setLocalSub(id, !currently);
        btn.textContent = !currently ? 'Subscribed' : 'Subscribe';
        btn.classList.toggle('subscribed', !currently);

      } catch (err) {
        console.error('subscribe/unsubscribe failed', err);
        alert('Subscription failed: ' + (err.message || 'unknown'));
        btn.textContent = currently ? 'Subscribed' : 'Subscribe';
      } finally {
        btn.disabled = false;
      }
    }

    async function load(q = '') {
      currentQuery = q;
      const grid = document.getElementById('grid');
      try {
        const url = q ? `/api/games?q=${encodeURIComponent(q)}` : '/api/games';
        const r = await fetch(url);
        if (!r.ok) throw new Error('Failed to load: ' + r.status);
        const list = await r.json();
        const arr = Array.isArray(list) ? list : (list.content || []);
        grid.innerHTML = arr.length ? arr.map(card).join('') : '<div class="col-12"><div class="alert alert-info">No games found.</div></div>';
        grid.querySelectorAll('button[data-del]').forEach(btn=> btn.addEventListener('click', ()=> handleDelete(decodeURIComponent(btn.getAttribute('data-del'))) ));
        grid.querySelectorAll('button[data-sub]').forEach(btn=> btn.addEventListener('click', ()=> handleCardSubscribe(decodeURIComponent(btn.getAttribute('data-sub')), btn) ));
      } catch(e){
        console.error(e);
        grid.innerHTML = '<div class="col-12"><div class="alert alert-danger">Could not load games.</div></div>';
      }
    }

    function debounce(fn, wait=300){
      let t;
      return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      const form = document.getElementById('searchForm');
      const input = document.getElementById('searchInput');
      const clear = document.getElementById('clearBtn');

      await loadCurrentUser();

      load();

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        load(input.value.trim());
      });

      clear.addEventListener('click', ()=>{
        input.value = '';
        load();
      });

      input.addEventListener('input', debounce(()=>{
        load(input.value.trim());
      }, 350));
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>