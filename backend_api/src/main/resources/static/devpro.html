<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Developer Profile - GamerBridge</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .profile-container { max-width: 800px; margin: 2rem auto; background: #1e2a38; padding: 2rem; border-radius: 12px; box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); color:#e5e7eb; }
    .profile-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; }
    .profile-header img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #2563eb; background:#0b1220; }
    .profile-header h1 { margin: 0; color:#fff; }
    .profile-bio { margin-bottom: 2rem; color: #cbd5e1; }
    .games-list { margin-top: 2rem; }
    .games-list h2 { margin-bottom: 1rem; color:#fff; }
    .game-item { background: #0d1117; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color:#e5e7eb; }
    .game-item h3 { margin: 0; color: #2563eb; }
    .game-item p { margin: 0.5rem 0 0; color: #9ca3af; }
    .btn { display:inline-block;padding:10px 14px;border-radius:8px;background:#10b981;color:#fff;text-decoration:none }
    .btn-secondary { background:#2563eb }
    .muted { color:#9ca3af }
    .center { text-align:center }
  </style>
</head>
<body>
  <!-- Navbar -->
  <header class="site-header">
    <div class="logo">ðŸŽ® GamerBridge</div>
    <nav class="navbar">
      <a href="../index.html">Home</a>
      <a href="#">Reviews</a>
      <a href="gamelist.html">Games</a>
      <a href="#">News</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <!-- Profile Container -->
  <main class="profile-container" id="profileContainer">
    <div class="profile-header">
      <img id="devAvatar" src="../assets/img/devsmile.png" alt="Developer avatar">
      <div>
        <h1 id="devName">Developer</h1>
        <p id="devRole" class="muted">â€”</p>
      </div>
    </div>

    <div class="profile-bio" id="devBio">
      <p>Loading developer profile...</p>
    </div>

    <p style="margin-top:1rem;">
      <a id="editBtn" href="editprof.html" class="btn btn-secondary" style="display:none">Edit Profile</a>
      <a id="loginPrompt" href="dlogin.html" class="btn" style="display:none">Developer Login</a>
      <a id="signupPrompt" href="dsignup.html" class="btn btn-secondary" style="display:none">Developer Sign up</a>
    </p>

    <div class="games-list">
      <h2>My Games</h2>
      <div id="gamesList">
        <p class="muted">Loading gamesâ€¦</p>
      </div>
    </div>

    <p style="margin-top:1.5rem; text-align:center;">
      <a id="addGameBtn" href="addgame.html" class="btn" style="display:none">âž• Add Game</a>
    </p>
  </main>

  <!-- Footer -->
  <footer class="site-footer center">
    <p>Â© 2025 GamerBridge</p>
  </footer>

  <script>
    (async function(){
      const devNameEl = document.getElementById('devName');
      const devBioEl = document.getElementById('devBio');
      const devAvatarEl = document.getElementById('devAvatar');
      const gamesListEl = document.getElementById('gamesList');
      const editBtn = document.getElementById('editBtn');
      const addGameBtn = document.getElementById('addGameBtn');
      const loginPrompt = document.getElementById('loginPrompt');
      const signupPrompt = document.getElementById('signupPrompt');

      // Try load profile from localStorage (set by dlogin/dsignup)
      let profile = null;
      try { profile = JSON.parse(localStorage.getItem('developerProfile')); } catch(e) { profile = null; }

      // Helper to render profile
      function renderProfile(p) {
        if (!p) {
          devNameEl.textContent = 'Developer';
          devBioEl.innerHTML = '<p>Please sign in or sign up to view your developer profile.</p>';
          loginPrompt.style.display = 'inline-block';
          signupPrompt.style.display = 'inline-block';
          editBtn.style.display = 'none';
          addGameBtn.style.display = 'none';
          gamesListEl.innerHTML = '<p class="muted">No games to show.</p>';
          return;
        }

        devNameEl.textContent = p.name || p.displayName || ('Developer #' + (p.id || 'â€”'));
        devBioEl.innerHTML = '<p>' + (p.bio || p.description || 'No bio provided.') + '</p>';
        if (p.avatarUrl) devAvatarEl.src = p.avatarUrl;
        editBtn.style.display = 'inline-block';
        addGameBtn.style.display = 'inline-block';
        loginPrompt.style.display = 'none';
        signupPrompt.style.display = 'none';

        // games from profile if present
        if (Array.isArray(p.games) && p.games.length) {
          gamesListEl.innerHTML = '';
          p.games.forEach(g => {
            const div = document.createElement('div');
            div.className = 'game-item';
            div.innerHTML = '<h3>' + (g.title || 'Untitled') + '</h3>' +
                            '<p>' + (g.description || '') + '</p>';
            gamesListEl.appendChild(div);
          });
        } else {
          gamesListEl.innerHTML = '<p class="muted">No games published yet.</p>';
        }
      }

      // If profile available in localStorage render it immediately
      if (profile) {
        renderProfile(profile);
        // attempt background refresh by id if id present
        if (profile.id) {
          try {
            const r = await fetch('/api/developers/' + profile.id);
            if (r.ok) {
              const latest = await r.json();
              // merge games if endpoint provides them
              if (latest) {
                // keep local games if present, otherwise use latest.games
                if (!profile.games && latest.games) latest.games = latest.games;
                localStorage.setItem('developerProfile', JSON.stringify(latest));
                renderProfile(latest);
              }
            }
          } catch (e) { /* ignore network errors */ }
        }
        return;
      }

      // otherwise try to fetch "current" developer if backend exposes it
      try {
        // attempt common endpoints: /api/developers/me then fallback to list
        let resp = await fetch('/api/developers/me');
        if (!resp.ok) {
          resp = await fetch('/api/developers'); // maybe returns list
          if (resp.ok) {
            const list = await resp.json();
            if (Array.isArray(list) && list.length) {
              // choose first as fallback
              renderProfile(list[0]);
              return;
            }
          }
          // no developer info available
          renderProfile(null);
          return;
        }

        const dev = await resp.json();
        if (dev) {
          localStorage.setItem('developerProfile', JSON.stringify(dev));
          renderProfile(dev);
        } else {
          renderProfile(null);
        }
      } catch (err) {
        console.warn('Failed to load developer profile', err);
        renderProfile(null);
      }
    })();
  </script>
</body>
</html>